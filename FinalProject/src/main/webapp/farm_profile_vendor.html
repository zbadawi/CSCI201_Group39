<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Profile</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link href="https://cdn.jsdelivr.net/npm/open-iconic@1.1.1/font/css/open-iconic-bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="style.css" />
	<script src="scripts/navbar.js" defer></script>
	<style>
		#profile-header {
			height: 35vh;
			background-color: green;
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		#profile-pic {
			width: auto;
			height: 100px;
			display: block;
			margin-right: 20px;
		}

		#user-info {
			display: flex;
			align-items: center;
			margin-top: 50px;
		}

		#user-info h2 {
			margin: 0;
		}

		#user-type {
			margin-left: auto;
			margin-right: 20px;
		}

		#main-text {
			margin-top: 40px;
		}

		.add-product-container {
			display: flex;
			flex-direction: column;
			align-items: left;
			padding: 20px;
		}

		.add-product-text {
			grid-column: span 2;
		}

		#form-container {
			flex-direction: row;
			align-items: left;
		}

		input {
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			box-sizing: border-box;
		}

		input[type="submit"] {
			grid-column: span 2;
			background-color: #2cc54e;
			color: white;
			cursor: pointer;
		}

		.error {
			color: red;
			margin-top: 5px;
		}

		.card-container {
			display: flex;
			flex-wrap: wrap;
			justify-content: space-between;

			font-size: 1.5em;
		}

		.card {
			/* Add shadows to create the "card" effect */
			box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
			transition: 0.3s;
			height: auto;
			width: 25%;
			margin: 20px;
			margin-top: 100px;
			padding: 15px;
		}

		/* On mouse-over, add a deeper shadow */
		.card:hover {
			box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
		}

		/* Add some padding inside the card container */
		.card>.container {
			padding: 2px 16px;
		}

		.img-container {
			display: flex;
			justify-content: center;
			align-items: center;
			width: 325px;
			height: 325px;

			overflow: hidden;
			position: relative;
		}

		.overlay-image {
			display: block;
			position: absolute;
			width: 50%;
		}

		.stall-img {
			display: block;
			object-fit: cover;
			height: 100%;
		}
	</style>
</head>

<body>
	<ul id="nav">
		<li><a href="farm_homepage.html"> Marketplace</a></li>
		<li><a id="active-nav" href="farm_profile_vendor.html">Profile</a></li>
		<li><a href="farm_checkout.html">Cart</a></li>
		<li id="login-register"><a href="farm_login.html">Login/Register</a>
			<ul>
				<li><a href="farm_login.html">Login</a></li>
				<li><a href="farm_signup.html">Register</a></li>
			</ul>
		</li>
	</ul>
	<!-- nav -->

	<h1 id="profile-header">Profile</h1>

	<div class="container profile-container">
		<div id="user-info">
			<img id="profile-pic" src="https://c.animaapp.com/jJByVzj4/img/ellipse-58@2x.png" alt="Profile Picture">
			<h2>Jack</h2>
			<div id="user-type">
				<h3>Vendor</h3>
			</div>
		</div>

		<div class="add-product-container row">
			<div id="main-text" class="col-4">
				<h2>Add a New Product!</h2>
				<form id="add-product-form" action="add-product" onsubmit="validateForm(event)">
					<div id="form-container" class="row">
						<div id="one-column">
							<label for="product-name" class="add-product-text">Product Name:</label>
							<input type="text" name="product-name" id="productName" placeholder="Product Name">
							<span id="productNameError" class="error"></span>

							<label for="price" class="add-product-text">Price:</label>
							<input type="text" name="price" id="price" placeholder="Price">
							<span id="priceError" class="error"></span>
						</div>
						<div id="two-column">
							<label for="image-url" class="add-product-text">Image URL:</label>
							<input type="text" name="image-url" id="imageUrl" placeholder="Image URL">
							<span id="imageUrlError" class="error"></span>

							<label for="quantity" class="add-product-text">Quantity:</label>
							<input type="text" name="quantity" id="quantity" placeholder="Quantity">
							<span id="quantityError" class="error"></span>
						</div>
					</div>
					<div id="button-container">
						<button type="button" id="add-product" class="btn btn-success" onclick="validateForm();">Add Product</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="card-container">
				<div class="card">
					<div class="img-container">
						<img src="img/stall.png" alt="Stall" style="width:100%" class="stall-img">
						<img src="img/fruit1.png" alt="Overlay" class="overlay-image">
					</div>

					<div class="container">
						<h4><b>Item Name</b></h4>
						<p>Item Price</p>
						<p>Quantity</p>
					</div>
				</div>
				<div class="card">
					<div class="img-container">
						<img src="img/stall.png" alt="Stall" style="width:100%" class="stall-img">
						<img src="img/fruit2.png" alt="Overlay" class="overlay-image">
					</div>
					<div class="container">
						<h4><b>Item Name</b></h4>
						<p>Item Price</p>
						<p>Quantity</p>
					</div>
				</div>
				<div class="card">
					<div class="img-container">
						<img src="img/stall.png" alt="Stall" style="width:100%" class="stall-img">
						<img src="img/fruit3.png" alt="Overlay" class="overlay-image">
					</div>
					<div class="container">
						<h4><b>Item Name</b></h4>
						<p>Item Price</p>
						<p>Quantity</p>
					</div>
				</div>
				<div class="card">
					<div class="img-container">
						<img src="img/stall.png" alt="Stall" style="width:100%" class="stall-img">
						<img src="img/fruit4.png" alt="Overlay" class="overlay-image">
					</div>
					<div class="container">
						<h4><b>Item Name</b></h4>
						<p>Item Price</p>
						<p>Quantity</p>
					</div>
				</div>
			</div> <!-- .card-container -->

		</div> <!-- .row -->
		<!-- Add more stalls as needed -->
	</div>

	<script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>

	<script>
		function validateForm() {
			console.log('button clicked');
			// Prevent the form from submitting by default
			event.preventDefault();

			// Reset previous error messages
			resetErrorMessages();

			// Get form values
			var productName = document.getElementById('productName').value;
			var price = document.getElementById('price').value;
			var imageUrl = document.getElementById('imageUrl').value;
			var quantity = document.getElementById('quantity').value;

			// Validation for integer values (positive or negative integers)
			var integerRegex = /^-?\d+$/;

			if (productName.trim() === '' || imageUrl.trim() === '') {
				showError('productName', 'Please fill in Product Name and Image URL');
			}

			if (!integerRegex.test(price)) {
				showError('price', 'Price must be an integer');
			}

			if (price.trim() === '') {
				showError('price', 'Price is required');
			}

			if (!integerRegex.test(quantity)) {
				showError('quantity', 'Quantity must be an integer');
			}

			if (quantity.trim() === '') {
				showError('quantity', 'Quantity is required');
			}

			if (isFormValid()) {
				addProductListing();
			}
		}

		function showError(elementId, errorMessage) {
			// Display the error message next to the input field
			var errorElement = document.getElementById(elementId + 'Error');
			errorElement.textContent = errorMessage;
		}

		function resetErrorMessages() {
			// Reset all error messages
			var errorElements = document.querySelectorAll('.error');
			errorElements.forEach(function (element) {
				element.textContent = '';
			});
		}

		function isFormValid() {
			// Check if there are any error messages
			var errorElements = document.querySelectorAll('.error');
			for (var i = 0; i < errorElements.length; i++) {
				if (errorElements[i].textContent !== '') {
					return false;
				}
			}
			return true;
		}

		function addProductListing() {
			// send request to server to add product to listing.
			const requestData = {
				action: 'add',
				name: document.getElementById('productName').value,
				vendor_id: JSON.parse(sessionStorage.user).user_id,
				quantity: 1,
				price: document.getElementById('price').value,
				image_url: document.getElementById('imageUrl').value
			};
			
			console.log(requestData);

			$.ajax({
				url: "product",
				method: "POST",
				data: requestData,
				success: function (data) {
					console.log('added product to listings');
					updateProductDetails(requestData);
					alert('Successfully added product!');
				},
				error: function (xhr, status, error) {
					
					console.log("couldn't add product: ", xhr.responseText);
					event.preventDefault();
				}
			});
		}

		$(document).ready(function () {
			$.ajax({
				url: "vendor?vendor_id=" + JSON.parse(sessionStorage.user).user_id,
				method: 'GET',
				success: function (result) {
					resultObj = JSON.parse(result);

					console.log('results: ', resultObj);

					// Clear before showing results
					document.querySelector(".card-container").innerHTML = '';

					// Create Cards
					resultObj.forEach(product => {
						updateProductDetails(product);
					})
				},
				error: function (error) {
					console.log(error);
				}
			});
		});

		function updateProductDetails(product) {
			const card = document.createElement('div')
			const imgContainer = document.createElement('div')
			const imgStall = document.createElement('img')
			const img = document.createElement('img')
			const txtContainer = document.createElement('div')
			const title = document.createElement('h4')
			const titleBold = document.createElement('b')
			const price = document.createElement('p')
			const quantity = document.createElement('p')

			card.classList.add('card')
			imgContainer.classList.add('img-container')
			txtContainer.classList.add('container')

			imgStall.src = 'img/stall.png'
			imgStall.alt = 'Stall'
			imgStall.classList.add('stall-img')
			imgStall.style.width = '100%'

			img.src = product.image_url;
			img.alt = product.name + ' Product Image'
			img.classList.add('overlay-image')

			titleBold.innerHTML = product.name
			price.innerHTML = 'Price: $' + product.price
			quantity.innerHTML = 'Stock Available: ' + product.quantity

			title.appendChild(titleBold)

			imgContainer.appendChild(imgStall)
			imgContainer.appendChild(img)

			txtContainer.appendChild(title)
			txtContainer.appendChild(price)
			txtContainer.appendChild(quantity)

			card.appendChild(imgContainer)
			card.appendChild(txtContainer)

			document.querySelector(".card-container").appendChild(card)
			
		}

		function findLastElementChild(parent) {
			var lastChild = parent.lastChild;
			while (lastChild && lastChild.nodeType !== 1) {
				lastChild = lastChild.previousSibling;
			}
			return lastChild;
		}



	</script>

</body>

</html>